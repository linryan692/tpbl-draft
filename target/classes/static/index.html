<!DOCTYPE html>
<html lang="zh-Hant" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8" />
  <title>TPBL 選秀系統</title>
  <style>
    /* 同原先樣式… */
  </style>
</head>
<body>
  <h1>TPBL 選秀系統</h1>

  <!-- 注入當前 teamId -->
  <script th:inline="javascript">
    /*<![CDATA[*/
    window.CURRENT_TEAM_ID = /*[[${#authentication.principal.id}]]*/ 0;
    /*]]>*/
  </script>

  <div class="team">
    <h2>目前輪到：</h2>
    <div id="current-team">載入中…</div>
    <button id="pass-btn" disabled>放棄</button>
  </div>

  <div class="players">
    <h2>可選球員</h2>
    <div id="players-list">載入中…</div>
  </div>

  <div class="picks">
    <h2>已選紀錄</h2>
    <div id="picks-table-container">載入中…</div>
  </div>

  <script>
    const currentEl   = document.getElementById('current-team');
    const playersEl   = document.getElementById('players-list');
    const tableCon    = document.getElementById('picks-table-container');
    const passBtn     = document.getElementById('pass-btn');

    let ws, currentTeamId = window.CURRENT_TEAM_ID;

    function initWebSocket() {
      ws = new WebSocket(`ws://${location.host}/ws/draft`);
      ws.onopen    = () => console.log('WS 已連線');
      ws.onerror   = e => console.error('WS 錯誤', e);
      ws.onclose   = () => console.log('WS 已關閉');
      ws.onmessage = e => handleEvent(JSON.parse(e.data));
    }

    function handleEvent(evt) {
      const { type, data } = evt;
      switch(type) {
        case 'FULL_STATUS':
          renderFullStatus(data);
          break;
        case 'NEXT_TURN':
          updateCurrent(data);
          break;
        case 'DRAFT_ENDED':
          currentEl.textContent = '選秀結束';
          playersEl.innerHTML = '';
          passBtn.disabled = true;
          break;
      }
    }

    function renderFullStatus(status) {
      updateCurrent(status.currentTeam);
      renderPlayersByPosition(status.availablePlayers);
      renderPicksTable(status.teams, status.picks);
    }

    function updateCurrent(team) {
      if (team) {
        currentEl.textContent = `${team.id} - ${team.name}`;
        passBtn.disabled = (team.id !== currentTeamId);
      } else {
        currentEl.textContent = '選秀結束';
        passBtn.disabled = true;
      }
    }

    function renderPlayersByPosition(list) {
      const grouped = list.reduce((acc, p) => {
        (acc[p.position] = acc[p.position]||[]).push(p);
        return acc;
      }, {});
      playersEl.innerHTML = '';
      Object.entries(grouped).forEach(([pos, arr]) => {
        const div = document.createElement('div');
        div.innerHTML = `<strong>${pos} (${arr.length})</strong>`;
        arr.forEach(p => {
          const btn = document.createElement('button');
          btn.textContent = `${p.id}:${p.name}`;
          btn.disabled = (currentTeamId !== parseInt(currentEl.textContent));
          btn.onclick = () => {
            if (currentTeamId === parseInt(currentEl.textContent)) {
              ws.send(JSON.stringify({ playerId: p.id }));
            }
          };
          div.appendChild(btn);
        });
        playersEl.appendChild(div);
      });
    }

    function renderPicksTable(teams, picks) {
      const maxRound = Math.max(0, ...picks.map(p=>p.round));
      const grid = [];
      for (let r=1; r<=maxRound; r++) {
        const row = teams.map(_=>null);
        picks.filter(p=>p.round===r).forEach(p => {
          const idx = teams.findIndex(t=>t.id===p.team.id);
          row[idx] = p.player ? p.player.name : '放棄';
        });
        grid.push({ round: r, row });
      }

      const tbl = document.createElement('table');
      const thead = document.createElement('thead');
      const head = `<th>輪次</th>` + teams.map(t=>`<th>${t.name}</th>`).join('');
      thead.innerHTML = `<tr>${head}</tr>`;
      tbl.appendChild(thead);

      const tbody = document.createElement('tbody');
      grid.forEach(({round,row}) => {
        const cells = `<td>${round}</td>` + row.map(c=>`<td>${c||''}</td>`).join('');
        const tr = document.createElement('tr');
        tr.innerHTML = cells;
        tbody.appendChild(tr);
      });
      tbl.appendChild(tbody);

      tableCon.innerHTML = '';
      tableCon.appendChild(tbl);
    }

    passBtn.onclick = () => {
      if (currentTeamId === parseInt(currentEl.textContent)) {
        ws.send(JSON.stringify({ playerId: null }));
      }
    };

    initWebSocket();
  </script>
</body>
</html>
