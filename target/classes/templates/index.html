<!DOCTYPE html>
<html lang="zh-Hant"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8" />
  <title>TPBL 選秀系統</title>
  <style>/* … 你的原有 CSS … */</style>
</head>
<body>

  <h1>TPBL 選秀系統</h1>

  <!-- 只有登录后才让前端逻辑跑 -->
  <sec:authorize access="isAuthenticated()">
    <!-- 把 team.id 放到前端全局变量 -->
    <script th:inline="javascript">
      /*<![CDATA[*/
      window.CURRENT_TEAM_ID = /*[[${team.id}]]*/ 0;
      window.ALL_TEAMS       = /*[[${#objects.toJson(teams)}]]*/ [];
      /*]]>*/
    </script>

    <div class="team">
      <h2>目前輪到：</h2>
      <div id="current-team">載入中…</div>
      <button id="pass-btn" disabled>放棄</button>
    </div>

    <div class="players">
      <h2>可選球員</h2>
      <div id="players-list">載入中…</div>
    </div>

    <div class="picks">
      <h2>已選紀錄</h2>
      <div id="picks-table-container">載入中…</div>
    </div>
  </sec:authorize>

  <sec:authorize access="!isAuthenticated()">
    <p>請先 <a th:href="@{/login}">登入</a> 再查看選秀頁面。</p>
  </sec:authorize>

  <script>
    // 下面的 WS + 渲染逻辑可以保持不变，
    // 只是 currentTeamId 改成从 window.CURRENT_TEAM_ID 读取
    const currentEl   = document.getElementById('current-team');
    const playersEl   = document.getElementById('players-list');
    const tableCon    = document.getElementById('picks-table-container');
    const passBtn     = document.getElementById('pass-btn');

    let ws, currentTeamId = window.CURRENT_TEAM_ID;
    const teams = window.ALL_TEAMS;

    function initWebSocket() {
      ws = new WebSocket(`ws://${location.host}/ws/draft`);
      ws.onmessage = e => handleEvent(JSON.parse(e.data));
      // … 其余同前 …
    }

    function handleEvent(evt) {
      const { type, data } = evt;
      switch(type) {
        case 'FULL_STATUS':
          renderFullStatus(data);
          break;
        case 'NEXT_TURN':
          updateCurrent(data);
          break;
        case 'DRAFT_ENDED':
          currentEl.textContent = '選秀結束';
          playersEl.innerHTML = '';
          passBtn.disabled = true;
          break;
      }
    }

    function renderFullStatus(status) {
      updateCurrent(status.currentTeam);
      renderPlayersByPosition(status.availablePlayers);
      renderPicksTable(teams, status.picks);
    }

    function updateCurrent(team) {
      if (team) {
        currentEl.textContent = `${team.id} - ${team.name}`;
        passBtn.disabled = (team.id !== currentTeamId);
      } else {
        currentEl.textContent = '選秀結束';
        passBtn.disabled = true;
      }
    }

    // … 其余函数 renderPlayersByPosition、renderPicksTable、passBtn.onclick 保持一致 …
    initWebSocket();
  </script>
</body>
</html>