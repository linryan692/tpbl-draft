<!DOCTYPE html>
<html lang="zh-Hant"
      xmlns:th="http://www.thymeleaf.org"
      xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
  <meta charset="UTF-8" />
  <title>TPBL 選秀系統</title>
  <style>
    /* 基本 reset */
    * { box-sizing: border-box; margin:0; padding:0; }
    body { font-family: 'Noto Sans TC', sans-serif; background:#f4f6f8; color:#333; }
    h1, h2 { margin-bottom:0.5em; }

    /* 頂欄 */
    .navbar { color:#fff; padding:1rem; display:flex; justify-content:space-between; align-items:center; }
    .navbar a { color:rgba(255,255,255,0.8); text-decoration:none; }

    .container { width:90%; max-width:1200px; margin:2rem auto; }

    /* 區塊卡片 */
    .card { background:#fff; border-radius:8px; padding:1rem; margin-bottom:2rem; box-shadow:0 2px 6px rgba(0,0,0,0.1); }
    .card h2 { border-bottom:1px solid #ddd; padding-bottom:0.5rem; margin-bottom:1rem; }

    /* 按鈕 */
    button { font-size:1rem; padding:0.5rem 1rem; border:none; border-radius:4px; cursor:pointer; transition:all .2s; }
    button:disabled { background:#bbb; color:#eee; cursor:default; }
    .btn-pick { background:#3498db; color:#fff; margin:0.3rem; }
    .btn-pick:hover:not(:disabled) { background:#2980b9; }
    .btn-pass { background:#e74c3c; color:#fff; }
    .btn-pass:hover:not(:disabled) { background:#c0392b; }

    /* 球員列表 Grid */
    .players-list { display:grid; grid-template-columns: repeat(auto-fill, minmax(120px,1fr)); gap:0.5rem; }
    .group-title { grid-column:1/-1; font-weight:600; margin-top:1rem; }

    /* 已選紀錄表格 */
    table { width:100%; border-collapse:collapse; }
    th, td { border:1px solid #ddd; padding:0.6rem; text-align:center; }
    th { background:#ecf0f1; }
  </style>
</head>
<body>
  <div class="navbar" id="navbar">
    <div><strong>TPBL 選秀系統</strong></div>
    <sec:authorize access="isAuthenticated()">
      <div>已登入：<span id="team-name" th:text="${teamName}">球團</span></div>
    </sec:authorize>
  </div>

  <div class="container">
    <sec:authorize access="!isAuthenticated()">
      <p>請先 <a th:href="@{/login}">登入</a> 再查看選秀頁面。</p>
    </sec:authorize>

    <sec:authorize access="isAuthenticated()">
      <script th:inline="javascript">
        /*<![CDATA[*/
        window.CURRENT_TEAM_ID = /*[[${teamId}]]*/ 0;
        window.TEAM_NAME       = /*[['${teamName}']]*/ '球團';
        /*]]>*/
      </script>

      <!-- 目前輪到 -->
      <div class="card">
        <h2>目前輪到</h2>
        <div id="current-team" style="font-size:1.2rem; margin-bottom:1rem;">載入中…</div>
        <button id="pass-btn" class="btn-pass" disabled>放棄</button>
      </div>

      <!-- 可選球員 -->
      <div class="card">
        <h2>可選球員</h2>
        <div id="players-list" class="players-list">載入中…</div>
      </div>

      <!-- 已選紀錄 -->
      <div class="card">
        <h2>已選紀錄</h2>
        <div id="picks-table-container">載入中…</div>
      </div>
    </sec:authorize>
  </div>

  <script>
    document.addEventListener('DOMContentLoaded', ()=> {
      // NAVBAR 根據 TEAM_NAME 設色
      const teamColors = {
        '富邦悍將': '#003366',
        '華碩天際龍': '#CC0000',
        '統一獅': '#FF6600',
        'Lamigo桃猿': '#66CCFF',
        '三商虎': '#FFCC00',
        '崇越隼鷹': '#009966',
        '遠東獵狐': '#9966CC',
        '國泰犀牛': '#999999'
      };
      const nav = document.getElementById('navbar');
      const tnm = window.TEAM_NAME;
      nav.style.background = teamColors[tnm] || '#2c3e50';
    });

    const currentEl   = document.getElementById('current-team');
    const playersEl   = document.getElementById('players-list');
    const tableCon    = document.getElementById('picks-table-container');
    const passBtn     = document.getElementById('pass-btn');
    const posMap      = { P:'投手', I:'內野手', O:'外野手', C:'捕手' };
    let ws, myTeamId  = window.CURRENT_TEAM_ID, currentTurnId = null;

    function initWebSocket() {
      ws = new WebSocket(`ws://${location.host}/ws/draft`);
      ws.onopen    = () => console.log('WS 已連線');
      ws.onerror   = e => console.error(e);
      ws.onmessage = e => handleEvent(JSON.parse(e.data));
    }

    function handleEvent(evt) {
      const { type, data } = evt;
      if (type==='FULL_STATUS')      renderFullStatus(data);
      else if (type==='NEXT_TURN')   updateCurrent(data);
      else if (type==='DRAFT_ENDED') {
        currentEl.textContent = '選秀結束';
        playersEl.innerHTML   = '';
        passBtn.disabled      = true;
      }
    }

    function renderFullStatus(status) {
      currentTurnId = status.currentTeam?.id || null;
      updateCurrent(status.currentTeam);
      renderPlayersByPosition(status.availablePlayers);
      renderPicksTable(status.allTeams, status.picks);  // ← 改成 allTeams
    }

    function updateCurrent(team) {
      if (team) {
        currentEl.textContent = team.name;
        passBtn.disabled      = (team.id !== myTeamId);
      } else {
        currentEl.textContent = '選秀結束';
        passBtn.disabled      = true;
      }
    }

    function renderPlayersByPosition(list) {
      playersEl.innerHTML = '';
      const groups = list.reduce((acc,p)=>{
        (acc[p.position] = acc[p.position]||[]).push(p);
        return acc;
      }, {});
      ['P','I','O','C'].forEach(code=>{
        const arr = groups[code]||[];
        if (!arr.length) return;
        const title = document.createElement('div');
        title.className   = 'group-title';
        title.textContent = `${posMap[code]} (${arr.length})`;
        playersEl.appendChild(title);
        arr.forEach(p=>{
          const btn = document.createElement('button');
          btn.className   = 'btn-pick';
          btn.textContent = p.name;
          btn.disabled    = (currentTurnId !== myTeamId);
          btn.onclick     = () => {
            if (currentTurnId===myTeamId && confirm(`確定要指名 ${p.name} 嗎？`)) {
              btn.textContent = '…Loading…';
              ws.send(JSON.stringify({ playerId: p.id }));
            }
          };
          playersEl.appendChild(btn);
        });
      });
    }

    function renderPicksTable(allTeams, picks) {
      const maxR = Math.max(0, ...picks.map(p=>p.round));
      let html = '<table><thead><tr><th>輪次</th>' +
        allTeams.map(t=>`<th>${t.name}</th>`).join('') +
        '</tr></thead><tbody>';
      for (let r=1; r<=maxR; r++) {
        html += `<tr><td>${r}</td>`;
        allTeams.forEach(t=>{
          const pick = picks.find(p=>p.round===r && p.team.id===t.id);
          html += `<td>${pick ? (pick.player?.name||'放棄') : ''}</td>`;
        });
        html += '</tr>';
      }
      html += '</tbody></table>';
      tableCon.innerHTML = html;
    }

    passBtn.onclick = ()=>{
      if (currentTurnId===myTeamId && confirm('確定要放棄整個選秀？')) {
        passBtn.textContent = '…Loading…';
        ws.send(JSON.stringify({ playerId: null }));
      }
    };

    initWebSocket();
  </script>
</body>
</html>